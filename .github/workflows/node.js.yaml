# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-alpine:
    runs-on: ubuntu-latest

    env:
      SKIP_ENV_VALIDATION: true

    steps:
    - uses: actions/checkout@v4
    - name: Build and test on Alpine Linux
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/app \
          -w /app \
          -e SKIP_ENV_VALIDATION=true \
          -e npm_config_build_from_source=true \
          -e npm_config_target_platform=linux \
          -e npm_config_target_arch=x64 \
          node:22-alpine sh -c "
            apk add --no-cache python3 make g++ libc6-compat &&
            npm install --legacy-peer-deps &&
            npm i lightningcss-linux-x64-musl &&
            apk add --no-cache openssl &&
            [ -f .env.example ] && cp .env.example .env || true &&
            npx prisma generate &&
            npm run build --if-present &&
            npm test
          "